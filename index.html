<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Du Lich Cali - Đặt Vé</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAoCDsW6-3UzZI11TMH62uLTE1uP1yX2Ts&libraries=places"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #ffcc00, #ff9900, #ff6600);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        h1 {
            text-align: center;
            color: #d35400;
        }
        .contact-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        .language-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        select, input, button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        button {
            background: #d35400;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #e67e22;
        }
        .cost-estimate {
            margin-top: 20px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            select, input, button {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="language-toggle">
        <button onclick="toggleLanguage()">English</button>
    </div>
    <div class="container">
        <h1>Du Lich Cali</h1>
        <div class="contact-info">
            Duy Hoa, Phone: <a href="tel:714-227-6007">714-227-6007</a>, Email: <a href="mailto:dulichcali21@gmail.com">dulichcali21@gmail.com</a>
        </div>
        <select id="serviceType" onchange="toggleService()">
            <option value="airport">Dịch vụ sân bay</option>
            <option value="travel">Gói du lịch</option>
        </select>

        <!-- Airport Service Form -->
        <form id="airportForm" onsubmit="handleSubmit(event, 'airport')">
            <label for="airportServiceType">Loại dịch vụ</label>
            <select id="airportServiceType" name="serviceType" onchange="updateAirportForm()">
                <option value="pickup">Đón tại sân bay</option>
                <option value="dropoff">Đưa đến sân bay</option>
            </select>
            <label for="airport">Sân bay</label>
            <select id="airport" name="airport">
                <option value="SNA">SNA (Orange County)</option>
                <option value="LAX">LAX (Los Angeles)</option>
                <option value="LGB">LGB (Long Beach)</option>
            </select>
            <label for="address">Địa chỉ</label>
            <input id="address" name="address" type="text" placeholder="Nhập địa chỉ" required>
            <label for="numPeople">Số người</label>
            <input id="numPeople" name="numPeople" type="number" min="1" max="12" value="1" required onchange="updateCost()">
            <label for="pickupDate">Ngày giờ</label>
            <input id="pickupDate" name="pickupDate" type="datetime-local" required onchange="checkAvailability()">
            <label for="customerName">Họ tên</label>
            <input id="customerName" name="customerName" type="text" required>
            <label for="phone">Số điện thoại</label>
            <input id="phone" name="phone" type="tel" required>
            <div class="cost-estimate" id="airportCostEstimate"></div>
            <button type="submit">Gửi yêu cầu</button>
            <button type="button" onclick="payLater()">Thanh toán sau</button>
        </form>

        <!-- Travel Package Form -->
        <form id="travelForm" class="hidden" onsubmit="handleSubmit(event, 'travel')">
            <label for="package">Gói du lịch</label>
            <select id="package" name="package" onchange="updateTravelForm()">
                <option value="custom">Điểm đến tùy chỉnh</option>
                <option value="disneyland">Disneyland Adventure</option>
                <option value="sandiego">San Diego Family Fun</option>
                <option value="universal">Universal Hollywood</option>
                <option value="nationalparks">National Parks Explorer</option>
                <option value="citygetaway">City Getaway</option>
            </select>
            <label for="destinations">Điểm đến</label>
            <select id="destinations" name="destinations" multiple onchange="updateCost()">
                <option value="Disneyland">Disneyland</option>
                <option value="California Adventure">California Adventure</option>
                <option value="Universal Studios">Universal Studios</option>
                <option value="San Diego Zoo">San Diego Zoo</option>
                <option value="SeaWorld">SeaWorld</option>
                <option value="LegoLand">LegoLand</option>
                <option value="Las Vegas">Las Vegas</option>
                <option value="Grand Canyon">Grand Canyon</option>
                <option value="San Francisco">San Francisco</option>
                <option value="Yosemite">Yosemite</option>
                <option value="Lake Tahoe">Lake Tahoe</option>
                <option value="Reno">Reno</option>
                <option value="Silicon Valley">Silicon Valley</option>
            </select>
            <label for="ticketType">Loại vé (Disneyland/Universal)</label>
            <select id="ticketType" name="ticketType" onchange="updateCost()">
                <option value="regular">Regular</option>
                <option value="vip">VIP</option>
                <option value="express">Express</option>
            </select>
            <label for="numAdults">Số người lớn</label>
            <input id="numAdults" name="numAdults" type="number" min="0" value="0" onchange="updateTravelerCount()">
            <label for="numKids">Số trẻ em</label>
            <input id="numKids" name="numKids" type="number" min="0" value="0" onchange="updateTravelerCount()">
            <label for="numTravelers">Tổng số người</label>
            <input id="numTravelers" name="numTravelers" type="number" min="1" max="12" value="1" required>
            <label for="days">Số ngày</label>
            <input id="days" name="days" type="number" min="1" value="1" required onchange="updateCost()">
            <label for="pickupDateTravel">Ngày khởi hành</label>
            <input id="pickupDateTravel" name="pickupDate" type="datetime-local" required onchange="checkAvailability()">
            <label for="airportTravel">Sân bay</label>
            <select id="airportTravel" name="airport">
                <option value="SNA">SNA (Orange County)</option>
                <option value="LAX">LAX (Los Angeles)</option>
                <option value="LGB">LGB (Long Beach)</option>
            </select>
            <label for="lodging">Chỗ ở</label>
            <select id="lodging" name="lodging" onchange="updateLodging()">
                <option value="none">Không có</option>
                <option value="airbnb">Airbnb</option>
                <option value="hotel">Khách sạn</option>
            </select>
            <div id="noLodgingAddress" class="hidden">
                <label for="dropoffAddress">Địa chỉ điểm đến</label>
                <input id="dropoffAddress" name="dropoffAddress" type="text" placeholder="Nhập địa chỉ">
            </div>
            <label for="meals" id="mealsLabel" class="hidden">Bữa ăn tự nấu (Khu vực Vịnh)</label>
            <input id="meals" name="meals" type="checkbox" class="hidden" onchange="updateCost()">
            <label for="customerNameTravel">Họ tên</label>
            <input id="customerNameTravel" name="customerName" type="text" required>
            <label for="phoneTravel">Số điện thoại</label>
            <input id="phoneTravel" name="phone" type="tel" required>
            <label for="emailTravel">Email</label>
            <input id="emailTravel" name="email" type="email" required>
            <div class="cost-estimate" id="travelCostEstimate"></div>
            <button type="submit">Gửi yêu cầu</button>
            <button type="button" onclick="payWithPayPal()">Thanh toán qua PayPal</button>
        </form>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBw8WZLeSD_JrzJhChKaedZyP8XFdtStgY",
            authDomain: "dulichcali.firebaseapp.com",
            projectId: "dulichcali",
            storageBucket: "dulichcali.firebasestorage.app",
            messagingSenderId: "178151315890",
            appId: "1:178151315890:web:32179635828a6e150eecab",
            measurementId: "G-MM9TZVMTVL"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const translations = {
            vi: {
                title: "Du Lich Cali - Đặt Vé",
                serviceType: "Loại dịch vụ",
                airport: "Dịch vụ sân bay",
                travel: "Gói du lịch",
                airportServiceType: "Loại dịch vụ",
                pickup: "Đón tại sân bay",
                dropoff: "Đưa đến sân bay",
                address: "Địa chỉ",
                numPeople: "Số người",
                pickupDate: "Ngày giờ",
                customerName: "Họ tên",
                phone: "Số điện thoại",
                package: "Gói du lịch",
                custom: "Điểm đến tùy chỉnh",
                disneyland: "Disneyland Adventure",
                sandiego: "San Diego Family Fun",
                universal: "Universal Hollywood",
                nationalparks: "National Parks Explorer",
                citygetaway: "City Getaway",
                destinations: "Điểm đến",
                ticketType: "Loại vé (Disneyland/Universal)",
                regular: "Regular",
                vip: "VIP",
                express: "Express",
                numAdults: "Số người lớn",
                numKids: "Số trẻ em",
                numTravelers: "Tổng số người",
                days: "Số ngày",
                pickupDateTravel: "Ngày khởi hành",
                airportTravel: "Sân bay",
                lodging: "Chỗ ở",
                none: "Không có",
                airbnb: "Airbnb",
                hotel: "Khách sạn",
                dropoffAddress: "Địa chỉ điểm đến",
                meals: "Bữa ăn tự nấu (Khu vực Vịnh)",
                customerNameTravel: "Họ tên",
                phoneTravel: "Số điện thoại",
                emailTravel: "Email",
                submit: "Gửi yêu cầu",
                payLater: "Thanh toán sau",
                payPaypal: "Thanh toán qua PayPal"
            },
            en: {
                title: "Cali Travel - Booking",
                serviceType: "Service Type",
                airport: "Airport Service",
                travel: "Travel Package",
                airportServiceType: "Service Type",
                pickup: "Pickup at Airport",
                dropoff: "Drop-off at Airport",
                address: "Address",
                numPeople: "Number of People",
                pickupDate: "Date & Time",
                customerName: "Full Name",
                phone: "Phone Number",
                package: "Travel Package",
                custom: "Custom Destinations",
                disneyland: "Disneyland Adventure",
                sandiego: "San Diego Family Fun",
                universal: "Universal Hollywood",
                nationalparks: "National Parks Explorer",
                citygetaway: "City Getaway",
                destinations: "Destinations",
                ticketType: "Ticket Type (Disneyland/Universal)",
                regular: "Regular",
                vip: "VIP",
                express: "Express",
                numAdults: "Number of Adults",
                numKids: "Number of Kids",
                numTravelers: "Total Travelers",
                days: "Number of Days",
                pickupDateTravel: "Departure Date",
                airportTravel: "Airport",
                lodging: "Lodging",
                none: "No Lodging",
                airbnb: "Airbnb",
                hotel: "Hotel",
                dropoffAddress: "Destination Address",
                meals: "Home-cooked Meals (Bay Area)",
                customerNameTravel: "Full Name",
                phoneTravel: "Phone Number",
                emailTravel: "Email",
                submit: "Submit Request",
                payLater: "Pay Later",
                payPaypal: "Pay with PayPal"
            }
        };

        const distances = {
            "Disneyland": 60,
            "California Adventure": 60,
            "Universal Studios": 100,
            "San Diego Zoo": 190,
            "SeaWorld": 190,
            "LegoLand": 140,
            "Las Vegas": 540,
            "Grand Canyon": 960,
            "San Francisco": 860,
            "Yosemite": 700,
            "Lake Tahoe": 960,
            "Reno": 1000,
            "Silicon Valley": 760
        };

        const admissionFees = {
            "San Diego Zoo": { adult: 70, kid: 70 },
            "SeaWorld": { adult: 90, kid: 90 },
            "LegoLand": { adult: 100, kid: 100 },
            "Las Vegas": { adult: 0, kid: 0 },
            "Grand Canyon": { adult: 25, kid: 25 },
            "San Francisco": { adult: 0, kid: 0 },
            "Yosemite": { adult: 20, kid: 20 },
            "Lake Tahoe": { adult: 0, kid: 0 },
            "Reno": { adult: 0, kid: 0 },
            "Silicon Valley": { adult: 20, kid: 20 },
            "Disneyland": { regular: { adult: 150, kid: 100 }, vip: { adult: 300, kid: 200 }, express: { adult: 200, kid: 150 } },
            "California Adventure": { regular: { adult: 150, kid: 100 }, vip: { adult: 300, kid: 200 }, express: { adult: 200, kid: 150 } },
            "Universal Studios": { regular: { adult: 120, kid: 80 }, vip: { adult: 250, kid: 180 }, express: { adult: 180, kid: 130 } }
        };

        const lodgingCosts = {
            "Disneyland": { hotel: 200, airbnb: 150 },
            "California Adventure": { hotel: 200, airbnb: 150 },
            "Universal Studios": { hotel: 180, airbnb: 130 },
            "San Diego Zoo": { hotel: 160, airbnb: 120 },
            "SeaWorld": { hotel: 160, airbnb: 120 },
            "LegoLand": { hotel: 160, airbnb: 120 },
            "Las Vegas": { hotel: 120, airbnb: 100 },
            "Grand Canyon": { hotel: 140, airbnb: 110 },
            "San Francisco": { hotel: 250, airbnb: 200 },
            "Yosemite": { hotel: 180, airbnb: 140 },
            "Lake Tahoe": { hotel: 200, airbnb: 160 },
            "Reno": { hotel: 130, airbnb: 100 },
            "Silicon Valley": { hotel: 250, airbnb: 200 }
        };

        let currentLang = 'vi';

        function toggleLanguage() {
            currentLang = currentLang === 'vi' ? 'en' : 'vi';
            document.querySelector('.language-toggle button').textContent = currentLang === 'vi' ? 'English' : 'Tiếng Việt';
            document.title = translations[currentLang].title;
            updateFormLabels();
        }

        function updateFormLabels() {
            const t = translations[currentLang];
            document.querySelector('#serviceType option[value="airport"]').textContent = t.airport;
            document.querySelector('#serviceType option[value="travel"]').textContent = t.travel;
            document.querySelector('#airportForm label[for="airportServiceType"]').textContent = t.airportServiceType;
            document.querySelector('#airportForm select[id="airportServiceType"] option[value="pickup"]').textContent = t.pickup;
            document.querySelector('#airportForm select[id="airportServiceType"] option[value="dropoff"]').textContent = t.dropoff;
            document.querySelector('#airportForm label[for="airport"]').textContent = t.airport;
            document.querySelector('#airportForm label[for="address"]').textContent = t.address;
            document.querySelector('#airportForm label[for="numPeople"]').textContent = t.numPeople;
            document.querySelector('#airportForm label[for="pickupDate"]').textContent = t.pickupDate;
            document.querySelector('#airportForm label[for="customerName"]').textContent = t.customerName;
            document.querySelector('#airportForm label[for="phone"]').textContent = t.phone;
            document.querySelector('#airportForm button[type="submit"]').textContent = t.submit;
            document.querySelector('#airportForm button[type="button"]').textContent = t.payLater;

            document.querySelector('#travelForm label[for="package"]').textContent = t.package;
            document.querySelector('#travelForm select[id="package"] option[value="custom"]').textContent = t.custom;
            document.querySelector('#travelForm select[id="package"] option[value="disneyland"]').textContent = t.disneyland;
            document.querySelector('#travelForm select[id="package"] option[value="sandiego"]').textContent = t.sandiego;
            document.querySelector('#travelForm select[id="package"] option[value="universal"]').textContent = t.universal;
            document.querySelector('#travelForm select[id="package"] option[value="nationalparks"]').textContent = t.nationalparks;
            document.querySelector('#travelForm select[id="package"] option[value="citygetaway"]').textContent = t.citygetaway;
            document.querySelector('#travelForm label[for="destinations"]').textContent = t.destinations;
            document.querySelector('#travelForm label[for="ticketType"]').textContent = t.ticketType;
            document.querySelector('#travelForm select[id="ticketType"] option[value="regular"]').textContent = t.regular;
            document.querySelector('#travelForm select[id="ticketType"] option[value="vip"]').textContent = t.vip;
            document.querySelector('#travelForm select[id="ticketType"] option[value="express"]').textContent = t.express;
            document.querySelector('#travelForm label[for="numAdults"]').textContent = t.numAdults;
            document.querySelector('#travelForm label[for="numKids"]').textContent = t.numKids;
            document.querySelector('#travelForm label[for="numTravelers"]').textContent = t.numTravelers;
            document.querySelector('#travelForm label[for="days"]').textContent = t.days;
            document.querySelector('#travelForm label[for="pickupDateTravel"]').textContent = t.pickupDateTravel;
            document.querySelector('#travelForm label[for="airportTravel"]').textContent = t.airportTravel;
            document.querySelector('#travelForm label[for="lodging"]').textContent = t.lodging;
            document.querySelector('#travelForm select[id="lodging"] option[value="none"]').textContent = t.none;
            document.querySelector('#travelForm select[id="lodging"] option[value="airbnb"]').textContent = t.airbnb;
            document.querySelector('#travelForm select[id="lodging"] option[value="hotel"]').textContent = t.hotel;
            document.querySelector('#travelForm label[for="dropoffAddress"]').textContent = t.dropoffAddress;
            document.querySelector('#travelForm label[for="meals"]').textContent = t.meals;
            document.querySelector('#travelForm label[for="customerNameTravel"]').textContent = t.customerNameTravel;
            document.querySelector('#travelForm label[for="phoneTravel"]').textContent = t.phoneTravel;
            document.querySelector('#travelForm label[for="emailTravel"]').textContent = t.emailTravel;
            document.querySelector('#travelForm button[type="submit"]').textContent = t.submit;
            document.querySelector('#travelForm button[type="button"]').textContent = t.payPaypal;
        }

        function toggleService() {
            const serviceType = document.getElementById('serviceType').value;
            document.getElementById('airportForm').classList.toggle('hidden', serviceType !== 'airport');
            document.getElementById('travelForm').classList.toggle('hidden', serviceType !== 'travel');
            updateCost();
        }

        function updateAirportForm() {
            const serviceType = document.getElementById('airportServiceType').value;
            const addressLabel = document.getElementById('address').parentElement;
            addressLabel.classList.toggle('hidden', serviceType === 'pickup');
            updateCost();
        }

        function updateTravelForm() {
            const package = document.getElementById('package').value;
            const destinations = document.getElementById('destinations');
            destinations.selectedOptions.length = 0;
            if (package === 'disneyland') {
                destinations.querySelector('option[value="Disneyland"]').selected = true;
                destinations.querySelector('option[value="California Adventure"]').selected = true;
            } else if (package === 'sandiego') {
                destinations.querySelector('option[value="San Diego Zoo"]').selected = true;
                destinations.querySelector('option[value="SeaWorld"]').selected = true;
                destinations.querySelector('option[value="LegoLand"]').selected = true;
            } else if (package === 'universal') {
                destinations.querySelector('option[value="Universal Studios"]').selected = true;
            } else if (package === 'nationalparks') {
                destinations.querySelector('option[value="Grand Canyon"]').selected = true;
                destinations.querySelector('option[value="Yosemite"]').selected = true;
            } else if (package === 'citygetaway') {
                destinations.querySelector('option[value="Las Vegas"]').selected = true;
                destinations.querySelector('option[value="San Francisco"]').selected = true;
                destinations.querySelector('option[value="Reno"]').selected = true;
            }
            updateMealsOption();
            updateCost();
        }

        function updateLodging() {
            const lodging = document.getElementById('lodging').value;
            document.getElementById('noLodgingAddress').classList.toggle('hidden', lodging !== 'none');
            updateCost();
        }

        function updateMealsOption() {
            const destinations = Array.from(document.getElementById('destinations').selectedOptions).map(opt => opt.value);
            const bayArea = ['San Francisco', 'Silicon Valley'].some(dest => destinations.includes(dest));
            document.getElementById('mealsLabel').classList.toggle('hidden', !bayArea);
            document.getElementById('meals').classList.toggle('hidden', !bayArea);
            updateCost();
        }

        function updateTravelerCount() {
            const adults = parseInt(document.getElementById('numAdults').value) || 0;
            const kids = parseInt(document.getElementById('numKids').value) || 0;
            const total = adults + kids;
            document.getElementById('numTravelers').value = total > 0 ? total : 1;
            updateCost();
        }

        async function calculateDistance(address) {
            if (!address) return 0;
            const geocoder = new google.maps.Geocoder();
            return new Promise((resolve) => {
                geocoder.geocode({ address: `Santa Ana, CA` }, (results1, status1) => {
                    if (status1 !== 'OK') return resolve(0);
                    geocoder.geocode({ address }, (results2, status2) => {
                        if (status2 !== 'OK') return resolve(0);
                        const origin = results1[0].geometry.location;
                        const destination = results2[0].geometry.location;
                        const service = new google.maps.DistanceMatrixService();
                        service.getDistanceMatrix({
                            origins: [origin],
                            destinations: [destination],
                            travelMode: 'DRIVING'
                        }, (response, status) => {
                            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                                const distanceMeters = response.rows[0].elements[0].distance.value;
                                resolve(distanceMeters / 1609.34); // Convert meters to miles
                            } else {
                                resolve(0);
                            }
                        });
                    });
                });
            });
        }

        async function updateCost() {
            const serviceType = document.getElementById('serviceType').value;
            if (serviceType === 'airport') {
                const airportServiceType = document.getElementById('airportServiceType').value;
                const airport = document.getElementById('airport').value;
                const address = document.getElementById('address').value;
                const numPeople = parseInt(document.getElementById('numPeople').value) || 1;
                let transportCost = 0;
                if (airportServiceType === 'pickup') {
                    transportCost = airport === 'SNA' && numPeople <= 3 ? 50 :
                                    airport === 'LAX' && numPeople <= 3 ? 100 :
                                    airport === 'LGB' && numPeople <= 3 ? 80 : 150;
                } else if (address) {
                    const zip = address.match(/\b\d{5}\b/)?.[0];
                    if (zip?.startsWith('926') || zip?.startsWith('927') || zip?.startsWith('928') || address.includes('Anaheim') || address.includes('Irvine') || address.includes('Huntington Beach')) {
                        transportCost = numPeople <= 3 ? 50 : 150;
                    } else if (zip?.startsWith('90')) {
                        transportCost = numPeople <= 3 ? 100 : 150;
                    } else if (zip?.startsWith('908')) {
                        transportCost = numPeople <= 3 ? 80 : 150;
                    } else {
                        const distance = await calculateDistance(address);
                        transportCost = distance * 2.5 * 2; // Round-trip
                    }
                }
                if (numPeople > 3) {
                    transportCost += 30;
                    transportCost *= 1.2;
                }
                document.getElementById('airportCostEstimate').innerHTML = `
                    <h3>${currentLang === 'vi' ? 'Ước tính chi phí' : 'Cost Estimate'}</h3>
                    <p>${currentLang === 'vi' ? 'Vận chuyển' : 'Transportation'}: $${transportCost.toFixed(2)}</p>
                    <p><strong>${currentLang === 'vi' ? 'Tổng' : 'Total'}: $${transportCost.toFixed(2)}</strong></p>
                `;
            } else {
                const destinations = Array.from(document.getElementById('destinations').selectedOptions).map(opt => opt.value);
                const ticketType = document.getElementById('ticketType').value;
                const numAdults = parseInt(document.getElementById('numAdults').value) || 0;
                const numKids = parseInt(document.getElementById('numKids').value) || 0;
                const numTravelers = parseInt(document.getElementById('numTravelers').value) || 1;
                const days = parseInt(document.getElementById('days').value) || 1;
                const lodging = document.getElementById('lodging').value;
                const dropoffAddress = document.getElementById('dropoffAddress').value;
                const meals = document.getElementById('meals').checked && ['San Francisco', 'Silicon Valley'].some(dest => destinations.includes(dest));
                const airport = document.getElementById('airportTravel').value;

                // Transportation Cost
                const maxDistance = Math.max(...destinations.map(dest => distances[dest] || 0));
                let transportCost = maxDistance * 2.5 * 2 * days;
                if (numTravelers > 3) {
                    transportCost += 30 * days;
                    transportCost *= 1.2;
                }

                // Airport Pickup Cost
                let airportCost = 0;
                if (lodging === 'none' && dropoffAddress) {
                    const zip = dropoffAddress.match(/\b\d{5}\b/)?.[0];
                    if (zip?.startsWith('926') || zip?.startsWith('927') || zip?.startsWith('928') || dropoffAddress.includes('Anaheim') || dropoffAddress.includes('Irvine') || dropoffAddress.includes('Huntington Beach')) {
                        airportCost = numTravelers <= 3 ? 50 : 150;
                    } else if (zip?.startsWith('90')) {
                        airportCost = numTravelers <= 3 ? 100 : 150;
                    } else if (zip?.startsWith('908')) {
                        airportCost = numTravelers <= 3 ? 80 : 150;
                    } else {
                        const distance = await calculateDistance(dropoffAddress);
                        airportCost = distance * 2.5 * 2;
                    }
                } else {
                    airportCost = numTravelers <= 3 ? 50 : 150;
                }
                if (numTravelers > 3) {
                    airportCost += 30;
                    airportCost *= 1.2;
                }

                // Admission Fees
                let admissionCost = 0;
                for (const dest of destinations) {
                    if (['Disneyland', 'California Adventure', 'Universal Studios'].includes(dest)) {
                        admissionCost += numAdults * (admissionFees[dest][ticketType].adult || 0);
                        admissionCost += numKids * (admissionFees[dest][ticketType].kid || 0);
                    } else {
                        admissionCost += numTravelers * (admissionFees[dest].adult || 0);
                    }
                }

                // Lodging Cost
                let lodgingCost = 0;
                if (lodging !== 'none') {
                    const primaryDest = destinations[0] || 'Disneyland';
                    const baseCost = lodgingCosts[primaryDest][lodging] || 150;
                    const rooms = numTravelers > 5 ? Math.ceil(numTravelers / 5) : 1;
                    lodgingCost = baseCost * rooms * days;
                    if (lodging === 'airbnb') {
                        lodgingCost += numTravelers * 20;
                    }
                }

                // Meals Cost
                const mealsCost = meals ? numTravelers * 35 * days : 0;

                const totalCost = transportCost + airportCost + admissionCost + lodgingCost + mealsCost;

                document.getElementById('travelCostEstimate').innerHTML = `
                    <h3>${currentLang === 'vi' ? 'Ước tính chi phí' : 'Cost Estimate'}</h3>
                    <p>${currentLang === 'vi' ? 'Vận chuyển' : 'Transportation'}: $${transportCost.toFixed(2)}</p>
                    <p>${currentLang === 'vi' ? 'Đón sân bay' : 'Airport Pickup'}: $${airportCost.toFixed(2)}</p>
                    <p>${currentLang === 'vi' ? 'Vé vào cổng' : 'Admission Tickets'}: $${admissionCost.toFixed(2)}</p>
                    <p>${currentLang === 'vi' ? 'Chỗ ở' : 'Lodging'}: $${lodgingCost.toFixed(2)}</p>
                    <p>${currentLang === 'vi' ? 'Bữa ăn' : 'Meals'}: $${mealsCost.toFixed(2)}</p>
                    <p><strong>${currentLang === 'vi' ? 'Tổng' : 'Total'}: $${totalCost.toFixed(2)}</strong></p>
                `;
            }
        }

        async function checkAvailability() {
            const dateInput = document.getElementById('serviceType').value === 'airport' ?
                document.getElementById('pickupDate') :
                document.getElementById('pickupDateTravel');
            const selectedDate = dateInput.value;
            if (!selectedDate) return;

            try {
                const startOfDay = new Date(selectedDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate);
                endOfDay.setHours(23, 59, 59, 999);

                const querySnapshot = await db.collection('bookings')
                    .where('pickupDate', '>=', startOfDay)
                    .where('pickupDate', '<=', endOfDay)
                    .get();

                if (!querySnapshot.empty) {
                    alert(currentLang === 'vi' ? 'Ngày này đã được đặt. Vui lòng chọn ngày khác.' : 'This date is booked. Please choose another date.');
                    dateInput.value = '';
                }
            } catch (error) {
                console.error('Availability check failed:', error);
                alert(currentLang === 'vi' ? 'Lỗi kiểm tra lịch. Vui lòng thử lại.' : 'Error checking availability. Please try again.');
            }
        }

        async function handleSubmit(event, formType) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const bookingData = Object.fromEntries(formData);

            // Convert pickupDate to Date object and add createdAt
            bookingData.pickupDate = new Date(bookingData.pickupDate);
            bookingData.createdAt = new Date();
            bookingData.serviceType = formType;

            // For travel service, handle array fields and boolean
            if (formType === 'travel') {
                bookingData.destinations = formData.getAll('destinations');
                bookingData.meals = bookingData.meals === 'on';
                bookingData.numAdults = parseInt(bookingData.numAdults) || 0;
                bookingData.numKids = parseInt(bookingData.numKids) || 0;
                bookingData.days = parseInt(bookingData.days) || 1;
                bookingData.numTravelers = parseInt(bookingData.numTravelers) || 1;
            } else {
                bookingData.numPeople = parseInt(bookingData.numPeople) || 1;
            }

            try {
                // Check availability
                const startOfDay = new Date(bookingData.pickupDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(bookingData.pickupDate);
                endOfDay.setHours(23, 59, 59, 999);

                const querySnapshot = await db.collection('bookings')
                    .where('pickupDate', '>=', startOfDay)
                    .where('pickupDate', '<=', endOfDay)
                    .get();

                if (!querySnapshot.empty) {
                    alert(currentLang === 'vi' ? 'Ngày này đã được đặt. Vui lòng chọn ngày khác.' : 'This date is booked. Please choose another date.');
                    return;
                }

                // Save to Firestore
                await db.collection('bookings').add(bookingData);

                // Forward to Formspree
                await axios.post('https://formspree.io/f/xeokgbpo', bookingData);

                // Redirect to thankyou.html
                window.location.href = 'thankyou.html';
            } catch (error) {
                console.error('Submission error:', error);
                alert(currentLang === 'vi' ? 'Lỗi khi gửi biểu mẫu. Vui lòng thử lại.' : 'Error submitting form. Please try again.');
            }
        }

        function payLater() {
            alert(currentLang === 'vi' ? 'Bạn sẽ thanh toán sau. Vui lòng lưu thông tin đặt chỗ.' : 'You will pay later. Please save your booking details.');
        }

        function payWithPayPal() {
            const totalCost = parseFloat(document.getElementById('travelCostEstimate').querySelector('strong').textContent.replace('$', '')) || 0;
            const form = document.createElement('form');
            form.action = 'https://www.paypal.com/cgi-bin/webscr';
            form.method = 'post';
            form.innerHTML = `
                <input type="hidden" name="cmd" value="_xclick">
                <input type="hidden" name="business" value="Johnntd21@icloud.com">
                <input type="hidden" name="item_name" value="Travel Package">
                <input type="hidden" name="amount" value="${totalCost.toFixed(2)}">
                <input type="hidden" name="currency_code" value="USD">
                <input type="hidden" name="return" value="https://johnntd.github.io/DuLichCali/thankyou.html">
            `;
            document.body.appendChild(form);
            form.submit();
        }

        function initGoogleMaps() {
            const addressInput = document.getElementById('address');
            const dropoffAddressInput = document.getElementById('dropoffAddress');
            const autocomplete1 = new google.maps.places.Autocomplete(addressInput);
            const autocomplete2 = new google.maps.places.Autocomplete(dropoffAddressInput);
            autocomplete1.addListener('place_changed', updateCost);
            autocomplete2.addListener('place_changed', updateCost);
        }

        document.addEventListener('DOMContentLoaded', () => {
            toggleService();
            updateFormLabels();
            initGoogleMaps();
            updateCost();
        });
    </script>
</body>
</html>
